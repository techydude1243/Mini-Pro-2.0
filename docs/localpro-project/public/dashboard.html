<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Provider Dashboard - LocalPro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #reviews {
      max-width: 500px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 32px 24px;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #reviews h2 {
      text-align: center;
      color: #2d6cdf;
      margin-bottom: 24px;
    }
    #reviewForm {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #reviewForm label {
      font-weight: 500;
      color: #444;
    }
    #reviewForm input, #reviewForm textarea {
      padding: 8px 10px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 1rem;
      background: #f7faff;
      transition: border 0.2s;
    }
    #reviewForm input:focus, #reviewForm textarea:focus {
      border-color: #2d6cdf;
      outline: none;
    }
    #reviewForm button {
      background: linear-gradient(90deg,#2d6cdf,#4fc3f7);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 0;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(45,108,223,0.12);
      transition: background 0.2s;
    }
    #reviewForm button:hover {
      background: linear-gradient(90deg,#4fc3f7,#2d6cdf);
    }
    #reviewsList {
      margin-top: 32px;
    }
    .review-card {
      background: #f7faff;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(45,108,223,0.07);
      padding: 16px 14px;
      margin-bottom: 18px;
      position: relative;
    }
    .review-rating {
      color: #ffb400;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .review-text {
      color: #333;
      font-size: 1rem;
      margin-bottom: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-900">LocalPro Dashboard</h1>
      <div>
        <a href="/" class="text-gray-700 hover:text-blue-600 mr-4 font-medium">Home</a>
        <button id="sign-out-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Sign Out</button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 md:p-8">
    <div id="loading" class="text-center text-gray-600 text-lg mt-8">Loading your profile...</div>

    <!-- Edit Profile View -->
    <div id="edit-profile-view" class="hidden">
      <h2 class="text-3xl font-bold mb-2">Welcome, <span id="provider-name"></span>!</h2>
      <p class="text-lg text-gray-600 mb-8">You are listed as a <span id="service-name" class="font-semibold"></span> provider.</p>
      <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
        <h3 class="text-2xl font-semibold mb-6 border-b pb-4">Update Your Public Profile</h3>
        <form id="edit-profile-form">
          <div class="mb-4">
            <label for="bio-edit" class="block text-gray-700 font-medium mb-2">Bio / Description</label>
            <textarea id="bio-edit" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></textarea>
          </div>
          <div class="mb-4">
            <label for="location-edit" class="block text-gray-700 font-medium mb-2">Location</label>
            <input type="text" id="location-edit" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          </div>
          <div class="mb-6">
            <label for="hourlyRate-edit" class="block text-gray-700 font-medium mb-2">Hourly Rate ($)</label>
            <input type="number" id="hourlyRate-edit" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          </div>
          <div class="flex items-center">
            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-semibold">Save Changes</button>
            <span id="success-message" class="ml-4 text-green-600 font-medium"></span>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Profile View -->
    <div id="create-profile-view" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Create Your Provider Profile</h2>
      <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
        <p class="text-gray-600 mb-6">Welcome! To be listed on LocalPro, please provide a few more details about your services.</p>
        <form id="create-profile-form">
          <div class="mb-4">
            <label for="serviceCategory-create" class="block text-gray-700 font-medium mb-2">What is your primary service?</label>
            <select id="serviceCategory-create" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required></select>
          </div>
          <div class="mb-4">
            <label for="location-create" class="block text-gray-700 font-medium mb-2">Location</label>
            <input type="text" id="location-create" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="e.g., New York" required>
          </div>
          <div class="mb-4">
            <label for="hourlyRate-create" class="block text-gray-700 font-medium mb-2">Hourly Rate ($)</label>
            <input type="number" id="hourlyRate-create" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="e.g., 75" required>
          </div>
          <div class="mb-6">
            <label for="bio-create" class="block text-gray-700 font-medium mb-2">Bio / Description</label>
            <textarea id="bio-create" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Describe your experience and services..."></textarea>
          </div>
          <div class="flex items-center">
            <button type="submit" id="create-profile-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-semibold">Create Profile</button>
            <span id="create-message" class="ml-4 font-medium"></span>
          </div>
        </form>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="mt-12 bg-red-50 border-l-4 border-red-400 p-6 rounded-lg shadow-md">
      <h3 class="text-2xl font-semibold text-red-800">Danger Zone</h3>
      <p class="text-red-700 mt-2 mb-4">Deleting your account is a permanent action and cannot be undone. This will permanently remove your user account and any associated provider profiles.</p>
      <button id="delete-account-btn" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 font-semibold">Delete My Account</button>
    </div>
  </main>

  <section id="reviews">
    <h2>Reviews & Ratings</h2>
    <form id="reviewForm">
      <label for="providerId">Provider ID:</label>
      <input type="text" id="providerId" name="providerId" required>
      <label for="serviceId">Service ID (optional):</label>
      <input type="text" id="serviceId" name="serviceId">
      <label for="rating">Rating (1-5):</label>
      <input type="number" id="rating" name="rating" min="1" max="5" required>
      <label for="reviewText">Review:</label>
      <textarea id="reviewText" name="reviewText" required rows="3"></textarea>
      <button type="submit">Submit Review</button>
    </form>
    <div id="reviewsList"></div>
  </section>

  <script>
    // Reviews logic
    async function loadReviews() {
      const providerId = document.getElementById('providerId').value;
      const serviceId = document.getElementById('serviceId').value;
      let url = '/api/reviews?';
      if (providerId) url += `provider=${providerId}&`;
      if (serviceId) url += `service=${serviceId}`;
      const res = await fetch(url);
      const reviews = await res.json();
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.innerHTML = reviews.map(r => `
        <div class="review-card">
          <div class="review-rating">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</div>
          <div class="review-text">${r.reviewText}</div>
        </div>
      `).join('');
    }

    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const provider = document.getElementById('providerId').value;
      const service = document.getElementById('serviceId').value;
      const rating = document.getElementById('rating').value;
      const reviewText = document.getElementById('reviewText').value;
      // Replace with actual user ID from authentication
      const user = 'USER_ID';
      await fetch('/api/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, provider, service, rating, reviewText })
      });
      loadReviews();
    });

    document.getElementById('providerId').addEventListener('change', loadReviews);
    document.getElementById('serviceId').addEventListener('change', loadReviews);

    // Dashboard logic
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const loadingDiv = document.getElementById('loading');
      const editProfileView = document.getElementById('edit-profile-view');
      const createProfileView = document.getElementById('create-profile-view');
      const editProfileForm = document.getElementById('edit-profile-form');
      const successMessage = document.getElementById('success-message');
      const createProfileForm = document.getElementById('create-profile-form');
      const createProfileBtn = document.getElementById('create-profile-btn');
      const createMessage = document.getElementById('create-message');
      const deleteBtn = document.getElementById('delete-account-btn');

      if (!token) {
        window.location.href = '/';
        return;
      }

      async function initializeDashboard() {
        try {
          const response = await fetch('/api/providers/me', {
            headers: { 'x-auth-token': token }
          });

          if (response.status === 404) {
            loadingDiv.classList.add('hidden');
            createProfileView.classList.remove('hidden');
            populateServicesDropdown();
          } else if (response.ok) {
            const provider = await response.json();
            populateEditForm(provider);
            loadingDiv.classList.add('hidden');
            editProfileView.classList.remove('hidden');
          } else {
            throw new Error('Could not fetch profile.');
          }
        } catch (error) {
          loadingDiv.textContent = error.message;
          console.error('Error:', error);
        }
      }

      function populateEditForm(provider) {
        document.getElementById('provider-name').textContent = provider.name;
        document.getElementById('service-name').textContent = provider.serviceCategory.name;
        document.getElementById('bio-edit').value = provider.bio || '';
        document.getElementById('location-edit').value = provider.location || '';
        document.getElementById('hourlyRate-edit').value = provider.hourlyRate || '';
      }

      async function populateServicesDropdown() {
        const select = document.getElementById('serviceCategory-create');
        const response = await fetch('/api/services');
        const services = await response.json();
        select.innerHTML = '<option value="">-- Select a Service --</option>';
        services.forEach(service => {
          const option = document.createElement('option');
          option.value = service._id;
          option.textContent = service.name;
          select.appendChild(option);
        });
      }

      editProfileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        successMessage.textContent = 'Saving...';
        const updatedData = {
          bio: document.getElementById('bio-edit').value,
          location: document.getElementById('location-edit').value,
          hourlyRate: document.getElementById('hourlyRate-edit').value,
        };
        const response = await fetch('/api/providers/me', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
          body: JSON.stringify(updatedData)
        });
        if (response.ok) {
          successMessage.textContent = 'Profile updated successfully!';
          setTimeout(() => successMessage.textContent = '', 3000);
        } else {
          successMessage.textContent = 'Update failed.';
        }
      });

      createProfileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        createMessage.textContent = 'Creating...';
        createMessage.classList.remove('text-red-500', 'text-green-600');
        createMessage.classList.add('text-gray-600');
        createProfileBtn.disabled = true;

        const newData = {
          serviceCategory: document.getElementById('serviceCategory-create').value,
          location: document.getElementById('location-create').value,
          hourlyRate: document.getElementById('hourlyRate-create').value,
          bio: document.getElementById('bio-create').value,
        };

        if (!newData.serviceCategory || !newData.location || !newData.hourlyRate) {
          createMessage.textContent = 'Please fill out all required fields.';
          createMessage.classList.add('text-red-500');
          createProfileBtn.disabled = false;
          return;
        }

        try {
          const response = await fetch('/api/providers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
            body: JSON.stringify(newData)
          });

          if (response.ok) {
            createMessage.textContent = 'Profile created successfully! Reloading...';
            createMessage.classList.remove('text-gray-600');
            createMessage.classList.add('text-green-600');
            setTimeout(() => window.location.reload(), 2000);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create profile.');
          }
        } catch (error) {
          createMessage.textContent = error.message;
          createMessage.classList.add('text-red-500');
          createProfileBtn.disabled = false;
        }
      });

      document.getElementById('sign-out-btn').addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = '/';
      });

      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete your account? This action is permanent.')) {
            try {
              const response = await fetch('/api/users/me', {
                method: 'DELETE',
                headers: { 'x-auth-token': token }
              });

              if (!response.ok) {
                throw new Error('Failed to delete account.');
              }

              localStorage.removeItem('token');
              alert('Your account has been successfully deleted.');
              window.location.href = '/';
            } catch (error) {
              console.error('Delete Error:', error);
              alert(error.message);
            }
          }
        });
      }

      initializeDashboard();
    });
  </script>
</body>
</html>